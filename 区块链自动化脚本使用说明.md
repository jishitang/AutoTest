# 区块链自动化脚本使用说明

## 前言

为了结合测试门户的使用，定制了一些通用的脚本itools.sh（已在测试门户的脚本配置中进行维护），包括清理，搭链，分发，启停，web3sdk调用，console调用等。

## 第一章 环境清理

### 1.1 脚本说明

该脚本主要做一个清理操作，即用户及目录下的autotest目录，如果之前就存在这个目录，会自动备份，如果不存在则新建。

### 1.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：clean

### 1.3 执行脚本

```shell
dos2unix sh itools.sh
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'clean'
```
## 第二章 代码拉取
### 2.1 脚本说明

该脚本主要拉取fisco-bcos代码，会新建目录~/autotest/FISCO-BCOS

### 2.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：install

param 5：fisco-bcos获取方式   0的意思直接从服务器download一个二进制  1的意思通过编译的方式获取二进制

param 6：fisco-bcos版本号，用于获取二进制后进行版本比较，是否达到期望

param 6：分支

### 2.3 执行脚本

```shell
dos2unix sh itools.sh
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'install' '0' '2.0.0-rc3' 'master'
```

## 第三章 创建节点

### 3.1 脚本说明

该脚本主要做build chain操作，会新建目录~/autotest/FISCO-BCOS/tools/nodes

### 3.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：buildchain

param 5：ipconf，具体格式为IP:节点数@归属机构@归属group   如有多个IP需要以#隔开

param 6：port起始值，具体格式为p2p,channel,jsonrpc

### 3.3 执行脚本

```shell
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'buildchain' '10.107.108.47:3@agency1@1,2#10.107.108.10:1@agency1@1#10.107.108.11:1@agency1@2' '30501,30401,8641'
```

## 第四章 节点分发

### 4.1 脚本说明

该脚本主要做分发节点操作，会备份和新建目录  ~/autotest/机器对应IP

### 4.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：transnodes

param 5：具体格式为IP,用户名,密码   如果要分发到多个IP需要以@隔开进行配置

### 4.3 执行脚本

```shell
dos2unix sh itools.sh
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'transnodes' '10.107.108.47,wangyang,Aa12345!@10.107.108.10,wangyang,Aa12345!@10.107.108.11,wangyang,Aa12345!'
```

## 第五章 启动节点

### 5.1 脚本说明

该脚本主要是拉起节点，然后检查节点上否拉起成功。

### 5.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：start

param 5：节点目录名，该参数可选，如果不传，则启动该IP下的所有节点，如果指定节点，则只启动该指定节点

### 5.3 执行脚本

```shell
dos2unix sh itools.sh
#启动该IP下的所有节点
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'start'
#启动该节点上的node0节点
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'start' 'node0'
```

## 第六章 停止节点

### 6.1 脚本说明

该脚本主要是停止节点，然后检查节点上否停止成功。

### 6.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：stop

param 5：节点目录名，该参数可选，如果不传，则停止该IP下的所有节点，如果指定节点，则只停止该指定节点

### 6.3 执行脚本

```shell
dos2unix sh itools.sh
#停止该IP下的所有节点
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'stop'
#停止该节点上的node0节点
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'stop' 'node0'
```

## 第七章 web3sdk安装

### 7.1 脚本说明

该脚本主要是安装web3sdk，然后自动配置applicationContext.xml文件，并且将sdk相关文件copy到web3sdk的conf目录下。会新建目录~/autotest/web3sdk

### 7.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：web3sdk

param 5：分支

param 6：0的意思是不需要安装web3sdk，直接执行命令     1的意思需要安装web3sdk

### 7.3 执行脚本

```shell
dos2unix sh itools.sh
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'web3sdk' 'master' '1'
```

## 第八章 web3sdk调用

### 8.1 脚本说明

该脚本主要是执行java-cp相关操作。

### 8.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：java-cp

param 5：java-cp后的具体参数

param 6：预期返回结果，可选

### 8.3 执行脚本

```shell
dos2unix sh itools.sh
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'java-cp' 'org.fisco.bcos.channel.test.contract.OkClient 1 deploy'

#可以传入预期返回结果
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'java-cp' 'org.fisco.bcos.channel.test.contract.OkClient 1 deploy' 'deploy contract successful'
```

## 第九章 console安装

### 9.1 脚本说明

该脚本主要是安装console

### 9.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：console

param 5：1的意思安装

param 6：分支

### 9.3 执行脚本

```shell
dos2unix sh itools.sh
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'console' '1' 'master'
```

## 第十章 console调用

### 9.1 脚本说明

该脚本主要是console调用

### 9.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：console

param 5：0的意思不安装

param 6：当param 5为0，则该参数传入具体执行的命令，如果param 5为1，则需要传入分支

param 7：param 5为1时有效，传入具体执行的命令

### 9.3 执行脚本

```shell
dos2unix sh itools.sh
#安装console，分支为dev
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'console' '1' 'dev'

#普通调用，可以通过测试门户中checkerror进行关键字检查
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'console' '0' 's 2#getSealerList'

#调用后检查是否match期望值  这里模式给1，这里的期望值是在执行s 2后返回"Switched to group 1"，如果期望值是在执行s 2后不返回"Switched to group 1"，则后面应给false
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'console' '0' 's 2|1|Switched to group 1|true'

#变量存储，通过关键字获取，这里模式给2。这里会将contract address对应的值放在变量v_get_address中，以备后面步骤使用
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'console' '0' 'deploy HelloWorld|2|v_get_address:contract address#getBlockNumber|2|v_gbn_console

#变量存储，函数调用，这里模式给2。给多变量赋值需要用;隔开。这里在给变量v_gbn_console_0x赋值的时候，首先调用itools里面的函数dec2hex，然后将返回值赋给v_gbn_console_0x
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'console' '0' 'deploy HelloWorld|2|v_get_address:contract address#getBlockNumber|2|v_gbn_console;v_gbn_console_0x:func(dec2hex ${v_gbn_console})'

#变量存储，通过jason解析获取，这里模式给2。如果console命令返回的结果是标准jason结构，可以用jq()方式进行解析
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'console' '0' 'getBlockByHash ${v_getBlockByNumber_hash}|2|v_getBlockByHash_blockhash:hash;v_getBlockByHash_logsBloom:logsBloom;v_getBlockByHash_number:number;v_getBlockByHash_parentHash:parentHash;v_getBlockByHash_sealer:sealer;v_getBlockByHash_stateRoot:stateRoot;v_getBlockByHash_timestamp:timestamp;v_getBlockByHash_transactionsRoot:transactionsRoot;v_getBlockByHash_transactions:jq(.transactions[0])'
```

## 第十一章 检查节点打包是否正常

### 10.1 脚本说明

该脚本主要是根据关键字检查节点运行日志，比如打包是否正常

### 10.2 脚本参数说明

param 1：执行机器IP

param 2：执行机器用户名

param 3：执行机器密码

param 4：check_dyn_log

param 5：关键字

param 6：节点目录名，该参数可选，如果不传，则检查所有节点的日志，否则检查传入节点的日志

### 10.3 执行脚本

```shell
dos2unix sh itools.sh
#检查所有节点
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'check_dyn_log' '++++++++'
#检查节点node0
sh itools.sh '10.107.108.47' 'wangyang' 'Aa12345!' 'check_dyn_log' '++++++++' 'node0'
```

